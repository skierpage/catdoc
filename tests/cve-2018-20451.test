#!/bin/bash
# Test for CVE-2018-20451 - Heap buffer over-read in process_file
# This CVE was originally found in libdoc, which is based on catdoc
# This test checks if catdoc has a similar vulnerability

set -e

CATDOC="../src/catdoc"
POC_FILE="libdoc_reader_process_file_203.overflow"

# Check if files exist
if [ ! -x "$CATDOC" ]; then
    echo "ERROR: catdoc not found: $CATDOC" >&2
    echo "Did you run 'make' first?" >&2
    exit 1
fi

# Check if built with Address Sanitizer
if ! ldd "$CATDOC" 2>/dev/null | grep -q libasan; then
    echo "SKIP: Test requires Address Sanitizer (configure with --enable-asan)"
    exit 77
fi

if [ ! -f "$POC_FILE" ]; then
    echo "ERROR: POC file not found: $POC_FILE" >&2
    exit 1
fi

# Run catdoc on the POC file with -b flag (broken OLE file)
# If built with ASan and vulnerable, this will crash with heap-buffer-overflow
# If fixed or ASan not enabled, this should complete (may produce garbage output)
# Suppress LeakSanitizer since we only care about heap-buffer-overflow
# Set CHARSETPATH if not already set
: ${CHARSETPATH:=$(dirname "$0")/../charsets}
if ASAN_OPTIONS=detect_leaks=0 CHARSETPATH="$CHARSETPATH" "$CATDOC" -b "$POC_FILE" > /dev/null 2>&1; then
    # Completed successfully
    exit 0
else
    # Crashed or errored
    echo "FAIL: CVE-2018-20451 - catdoc crashed on POC file" >&2
    exit 1
fi

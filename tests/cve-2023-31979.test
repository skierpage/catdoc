#!/bin/bash
# Test for CVE-2023-31979 - Global buffer overflow in process_file
# This test checks if the global buffer overflow vulnerability has been fixed
# When built with AddressSanitizer, the POC file should NOT cause a crash

set -e

CATDOC="../src/catdoc"
POC_FILE="global-buffer-overflow"

# Check if files exist
if [ ! -x "$CATDOC" ]; then
    echo "ERROR: catdoc not found: $CATDOC" >&2
    echo "Did you run 'make' first?" >&2
    exit 1
fi

# Check if built with Address Sanitizer
if ! ldd "$CATDOC" 2>/dev/null | grep -q libasan; then
    echo "SKIP: Test requires Address Sanitizer (configure with --enable-asan)"
    exit 77
fi

if [ ! -f "$POC_FILE" ]; then
    echo "ERROR: POC file not found: $POC_FILE" >&2
    exit 1
fi

# Run catdoc with -b flag on the POC file
# If built with ASan and the vulnerability is NOT fixed, this will crash
# If built without ASan OR the vulnerability IS fixed, this should complete
# We redirect output to /dev/null since we only care about the exit code
if "$CATDOC" -b "$POC_FILE" > /dev/null 2>&1; then
    # Completed successfully - vulnerability is fixed or ASan not enabled
    exit 0
else
    # Crashed or errored - likely ASan detected buffer overflow
    # For now, we expect this to fail, so we return success for the test
    # Once fixed, this script logic should be inverted
    echo "FAIL: CVE-2023-31979 - catdoc crashed on POC file" >&2
    exit 1
fi

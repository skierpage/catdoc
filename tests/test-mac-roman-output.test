#!/bin/bash
# Test mac-roman charset output
# Tests fix for https://github.com/vbwagner/catdoc/issues/14
# Without the fix (commit 8866ca937), xls2csv -d mac-roman would crash
# With the fix, it should output text in mac-roman encoding

set -e

# Support automake's separate build directories (srcdir is set by automake)
: ${srcdir=.}

TOOL="../src/xls2csv"
INPUTFILE="${srcdir}/hungarian.xls"
EXPECTEDFILE="${srcdir}/hungarian.xls.mac-roman.expected"

# Check if tool exists
if [ ! -x "$TOOL" ]; then
    echo "ERROR: Required tool not found: $TOOL" >&2
    echo "Did you run 'make' first?" >&2
    exit 1
fi

# Check if input file exists
if [ ! -f "$INPUTFILE" ]; then
    echo "ERROR: Input file not found: $INPUTFILE" >&2
    exit 1
fi

# Check if expected output file exists
if [ ! -f "$EXPECTEDFILE" ]; then
    echo "ERROR: Expected output file not found: $EXPECTEDFILE" >&2
    exit 1
fi

# Run xls2csv with -d mac-roman option
# This tests that the tool doesn't crash and produces mac-roman encoded output
# Suppress leak detection if built with ASAN (we're testing functionality, not leaks)
if ASAN_OPTIONS=detect_leaks=0 CHARSETPATH="../charsets" "$TOOL" -d mac-roman "$INPUTFILE" | diff -u --ignore-blank-lines --ignore-trailing-space "$EXPECTEDFILE" - >/dev/null 2>&1; then
    exit 0
else
    echo "FAIL: test-mac-roman-output (output differs from expected)" >&2
    ASAN_OPTIONS=detect_leaks=0 CHARSETPATH="../charsets" "$TOOL" -d mac-roman "$INPUTFILE" | diff -u --ignore-blank-lines --ignore-trailing-space "$EXPECTEDFILE" - >&2 || true
    exit 1
fi
